<div class="container-box"> 
  <app-title [title]="titleValue"></app-title>
  <section class="results-section">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">              
              <div class="scan-progress-container mb-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h5 class="mb-0">
                    <i class="fas fa-sync-alt" [ngClass]="{'fa-spin': scanProgress < 100 && !scanCancelled}"></i>
                    Scan Progress
                  </h5>
                  <div class="scan-status" [ngClass]="{
                    'text-warning': scanProgress < 100 && !scanCancelled, 
                    'text-success': scanProgress === 100,
                    'text-danger': scanCancelled
                  }">
                    <span *ngIf="scanProgress < 100 && !scanCancelled">Scanning in progress...</span>
                    <span *ngIf="scanProgress === 100">Scan completed</span>
                    <span *ngIf="scanCancelled">Scan cancelled</span>
                  </div>
                </div>
                
                <div class="progress" style="height: 25px;">
                  <div class="progress-bar progress-bar-striped" 
                      [ngClass]="{
                        'progress-bar-animated': scanProgress < 100 && !scanCancelled,
                        'bg-danger': scanCancelled,
                        'bg-success': scanProgress === 100
                      }"
                      role="progressbar" 
                      [style.width.%]="scanProgress" 
                      [attr.aria-valuenow]="scanProgress" 
                      aria-valuemin="0" 
                      aria-valuemax="100">
                    {{scanProgress}}%
                  </div>
                </div>
                
                <div class="scan-info mt-2 small text-muted">
                  <span *ngIf="scanProgress === 100">Scan completed at {{scanCompleteTime | date:'medium'}}</span>
                  <span *ngIf="scanCancelled">Scan was cancelled at {{scanCancelledTime | date:'medium'}}</span>
                </div>
                <div class="mt-3" *ngIf="scanProgress < 100 && !scanCancelled">
                  <button class="btn btn-danger btn-sm" 
                          (click)="cancelScan()" 
                          [disabled]="cancelling">
                    <i class="fas fa-times me-2"></i>
                    <span *ngIf="!cancelling">Cancel Scan</span>
                    <span *ngIf="cancelling">
                      <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                      Cancelling...
                    </span>
                  </button>
                </div>
              </div>
              <div class="alert alert-warning" *ngIf="scanCancelled">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Scan Cancelled:</strong> The security scan was cancelled before completion. 
                Results shown below are partial and may not represent the complete security status of the target.
              </div>
              <div class="action-buttons mt-4 d-flex flex-wrap gap-2 justify-content-end" *ngIf="scanProgress === 100 || scanCancelled">
                <button class="btn btn-outline-secondary" (click)="newScan()">
                  <i class="fas fa-sync-alt me-2"></i>New Scan
                </button>
                <app-download
                    [exportToPDF]="exportToPDF.bind(this)"
                    [exportToHTML]="exportToHTML.bind(this)"
                    [exportToCSV]="exportToCSV.bind(this)"
                    [downloadAllAsZip]="downloadAllAsZip.bind(this)">
                  </app-download>
              </div>
              <ul class="nav nav-tabs" role="tablist" *ngIf="scanProgress === 100 || scanCancelled">
                <li class="nav-item">
                  <a class="nav-link" 
                    [ngClass]="{ active: selectedTab === 'summary' }" 
                    (click)="selectedTab = 'summary'">
                    <i class="fas fa-chart-pie me-2"></i>Summary
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" 
                    [ngClass]="{ active: selectedTab === 'vulnerabilities' }" 
                    (click)="selectedTab = 'vulnerabilities'">
                    <i class="fas fa-bug me-2"></i>Vulnerabilities
                    <span class="badge bg-secondary ms-1" *ngIf="scanCancelled">(Partial)</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" 
                    [ngClass]="{ active: selectedTab === 'details' }" 
                    (click)="selectedTab = 'details'">
                    <i class="fas fa-list-alt me-2"></i>Details
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" 
                    [ngClass]="{ active: selectedTab === 'logs' }" 
                    (click)="selectedTab = 'logs'">
                    <i class="fas fa-terminal me-2"></i>Logs
                  </a>
                </li>
              </ul> 
              <div class="tab-content mt-4" *ngIf="scanProgress === 100 || scanCancelled">
                <div *ngIf="selectedTab === 'summary'" class="tab-pane fade show active">
                  <div class="summary-section">
                    <div class="alert alert-info" *ngIf="scanCancelled">
                      <i class="fas fa-info-circle me-2"></i>
                      <strong>Partial Results:</strong> This summary is based on incomplete scan data. 
                      Complete the scan for comprehensive security assessment.
                    </div>
                    <div class="card mb-2">
                      <div class="card-header">
                        <h5 class="mb-0">Target Information</h5>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <p><strong>URL:</strong> {{targetUrl}}</p>
                            <p><strong>Total Vulnerabilities:</strong> {{total_vuln}}</p>
                            <p><strong>IP Address:</strong> {{targetIp}}</p>
                            <p><strong>Server:</strong> {{serverInfo}}</p>
                          </div>
                          <div class="col-md-6">
                            <p><strong>Scan Started:</strong> {{scanStartTime | date:'medium'}}</p>
                            <p><strong>Scan Finished:</strong> {{scanEndTime | date:'medium'}}</p>
                            <p><strong>Scan Duration:</strong> {{scanDuration}}</p>
                            <p><strong>Tools Used:</strong> {{toolsUsed.join(', ')}}</p>
                            <p *ngIf="scanCancelled"><strong>Status:</strong> <span class="text-warning">Cancelled ({{scanProgress}}% complete)</span></p>
                          </div>
                          
                        </div>
                      </div>
                    </div>
                    <div class="card mb-2">
                      <div class="card-header">
                        <h5 class="mb-0">
                          Vulnerability Summary
                          <span class="badge bg-warning ms-2" *ngIf="scanCancelled">Partial</span>
                        </h5>
                      </div>
                      <div class="card-body">
                        <div class="row text-center">
                          <div class="col">
                            <div class="vuln-count high">
                              <span class="count">{{vulnerabilityCounts.high}}</span>
                              <span class="label">High</span>
                            </div>
                          </div>
                          <div class="col">
                            <div class="vuln-count medium">
                              <span class="count">{{vulnerabilityCounts.medium}}</span>
                              <span class="label">Medium</span>
                            </div>
                          </div>
                          <div class="col">
                            <div class="vuln-count low">
                              <span class="count">{{vulnerabilityCounts.low}}</span>
                              <span class="label">Low</span>
                            </div>
                          </div>
                          <div class="col">
                            <div class="vuln-count info">
                              <span class="count">{{vulnerabilityCounts.informational}}</span>
                              <span class="label">Info</span>
                            </div>
                          </div>
                           <div class="col">
                            <div class="vuln-count other">
                              <span class="count">{{vulnerabilityCounts.other}}</span>
                              <span class="label">Info</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>                 
                  </div>
                </div>
                <div *ngIf="selectedTab === 'vulnerabilities'" class="tab-pane fade show active">
                  <div class="alert alert-info" *ngIf="scanCancelled">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Partial Results:</strong> These vulnerabilities are based on incomplete scan data.
                  </div>
                  <div class="filters mb-2">
                    <div class="row">
                      <div class="col-md-4 mb-2">
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-search"></i></span>
                          <input type="text" class="form-control" placeholder="Search vulnerabilities..." 
                                [(ngModel)]="searchVulnerability" (input)="filterVulnerabilities()">
                        </div>
                      </div>
                      <div class="col-md-4 mb-2">
                        <select class="form-select" [(ngModel)]="severityFilter" (change)="filterVulnerabilities()">
                          <option value="">All Severities</option>
                          <option value="high">High</option>
                          <option value="medium">Medium</option>
                          <option value="low">Low</option>
                          <option value="informational">Informational</option>
                        </select>
                      </div>
                      <div class="col-md-4 mb-2">
                        <select class="form-select" [(ngModel)]="toolFilter" (change)="filterVulnerabilities()">
                          <option value="">All Tools</option>
                          <option *ngFor="let tool of toolsUsed" [value]="tool">{{tool}}</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="accordion" id="categoryAccordion">
                    <div class="accordion-item mb-2" *ngFor="let category of getFilteredCategories(); let categoryIndex = index">
                      <h2 class="accordion-header" [id]="'categoryHeading' + categoryIndex">
                        <button class="accordion-button collapsed" 
                                type="button" 
                                data-bs-toggle="collapse"
                                [attr.data-bs-target]="'#categoryCollapse' + categoryIndex" 
                                [attr.aria-expanded]="false" 
                                [attr.aria-controls]="'categoryCollapse' + categoryIndex"
                                [ngClass]="'bg-severity-' + category.risk.toLowerCase()">
                          <div class="d-flex justify-content-between align-items-center w-100 me-3">
                            <div>
                              <i class="fas fa-shield-alt me-2"></i>
                              {{category.title}}
                            </div>
                            <div class="d-flex align-items-center">
                              <span class="badge rounded-pill me-2" 
                                    [ngClass]="'bg-' + category.risk.toLowerCase()">
                                {{category.risk}}
                              </span>
                              <span class="badge bg-secondary">
                                {{category.total}} vulnerabilities
                              </span>
                            </div>
                          </div>
                        </button>
                      </h2>
                      <div [id]="'categoryCollapse' + categoryIndex" 
                          class="accordion-collapse collapse" 
                          [attr.aria-labelledby]="'categoryHeading' + categoryIndex" 
                          data-bs-parent="#categoryAccordion">
                        <div class="accordion-body">
                          <div class="card mb-1 bg-light">
                            <div class="card-body">
                              <h6 class="card-title-summary">Category Information</h6>
                              <div class="row">
                                <div class="col-md-6">
                                  <h6 class="title-category">Detection Tool:</h6>
                                </div>
                                <div class="col-md-6">
                                  <div class="stat-tools-container">
                                      <span *ngFor="let tool of category.tools.split(',')" class="stat-tool">
                                        {{ tool.trim() }}
                                      </span>
                                  </div>
                                </div>
                              </div>                              
                              <div *ngIf="getCategoryDetails(category).description">
                                <h6 class="title-category">Description</h6>
                                <p class="text-category">
                                  {{ expandedDescriptions[categoryIndex] 
                                      ? getCategoryDetails(category).description 
                                      : truncate(getCategoryDetails(category).description, 200) }}
                                      <button class="btn btn-link p-0 inline-block show-more" *ngIf="getCategoryDetails(category).description.length > 200"
                                        (click)="toggleDescription(categoryIndex)">
                                  {{ expandedDescriptions[categoryIndex] ? 'Show less' : 'Show more' }}
                                </button>
                                </p>
                              </div>
                              <div *ngIf="getCategoryDetails(category).solution">
                                <h6 class="title-category">General Solution</h6>
                                <p class="text-category">
                                  {{ expandedSolutions[categoryIndex] 
                                      ? getCategoryDetails(category).solution 
                                      : truncate(getCategoryDetails(category).solution, 200) }} 
                                <button class="btn btn-link p-0 inline-block show-more" *ngIf="getCategoryDetails(category).solution.length > 200"
                                        (click)="toggleSolution(categoryIndex)">
                                  {{ expandedSolutions[categoryIndex] ? 'Show less' : 'Show more' }}
                                </button>
                                </p>
                              </div>                              
                              <div *ngIf="getCategoryDetails(category).reference && getCategoryDetails(category).reference.length > 0">
                                <h6 class="title-category">References</h6>
                                <ul class="list-unstyled">
                                  <li *ngFor="let ref of getCategoryDetails(category).reference">
                                    <a [href]="ref" target="_blank" class="text-decoration-none ref-text">
                                      <i class="fas fa-external-link-alt me-1"></i>{{ref}}
                                    </a>
                                  </li>
                                </ul>
                              </div>
                            </div>
                          </div>
                          <div class="accordion" [id]="'vulnAccordion' + categoryIndex">
                            <div class="accordion-item mb-2" 
                                *ngFor="let vuln of getFilteredVulnerabilitiesForCategory(category); let vulnIndex = index">
                              <h3 class="accordion-header" [id]="'vulnHeading' + categoryIndex + '_' + vulnIndex">
                                <button class="accordion-button collapsed" 
                                        type="button" 
                                        data-bs-toggle="collapse"
                                        [attr.data-bs-target]="'#vulnCollapse' + categoryIndex + '_' + vulnIndex" 
                                        [attr.aria-expanded]="false" 
                                        [attr.aria-controls]="'vulnCollapse' + categoryIndex + '_' + vulnIndex">
                                  <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                    <div>
                                      <i class="fas fa-bug me-2"></i>
                                      <strong>{{vuln.real_name}}</strong>
                                    </div>
                                    <div class="d-flex align-items-center">
                                      <span class="badge bg-info me-2" *ngIf="vuln.confidence">
                                        Confidence: {{vuln.confidence}}
                                      </span>
                                      <span class="badge bg-primary me-2" *ngIf="vuln.confidence_score">
                                        Score: {{vuln.confidence_score}}
                                      </span>
                                      <span class="badge bg-secondary">
                                        {{vuln.detected_by}}
                                      </span>
                                    </div>
                                  </div>
                                </button>
                              </h3>
                              <div [id]="'vulnCollapse' + categoryIndex + '_' + vulnIndex" 
                                  class="accordion-collapse collapse" 
                                  [attr.aria-labelledby]="'vulnHeading' + categoryIndex + '_' + vulnIndex" 
                                  [attr.data-bs-parent]="'#vulnAccordion' + categoryIndex">
                                <div class="accordion-body">
                                <h6 class="card-title-summary">Vulnerability Information</h6>
                                  <div class="row mb-2">
                                    <div class="col-md-6">
                                      <h6 class="vuln-title">Basic Information</h6>
                                      <table class="table table-sm">
                                        <tr>
                                          <td  width="40%">Method:</td>
                                          <td  width="60%"><span class="badge bg-primary">{{vuln.method}}</span></td>
                                        </tr>
                                        <tr>
                                          <td>Detected By:</td>
                                          <td>{{vuln.detected_by}}</td>
                                        </tr>
                                        <tr *ngIf="vuln.confidence">
                                          <td>Confidence:</td>
                                          <td>
                                            <span class="badge" 
                                                  [ngClass]="{
                                                    'bg-success': vuln.confidence === 'High',
                                                    'bg-warning': vuln.confidence === 'Medium',
                                                    'bg-secondary': vuln.confidence === 'Low'
                                                  }">
                                              {{vuln.confidence}}
                                            </span>
                                          </td>
                                        </tr>
                                        <tr *ngIf="vuln.confidence_score">
                                          <td>Confidence Score:</td>
                                          <td>
                                            <div class="progress-confidance">
                                              <div class="progress-bar-confidance"
                                                [ngClass]="{
                                                  'low': +vuln.confidence_score < 40,
                                                  'medium': +vuln.confidence_score >= 40 && +vuln.confidence_score < 70,
                                                  'high': +vuln.confidence_score >= 70
                                                }"
                                                [style.width.%]="+vuln.confidence_score">
                                                {{vuln.confidence_score}}%
                                              </div>
                                            </div>
                                          </td>
                                        </tr>
                                      </table>
                                    </div>
                                    <div class="col-md-6">
                                      <h6 class="vuln-title">Target Information</h6>
                                      <p>URL:</p>
                                      <div class="code-block mb-2">{{vuln.url}}</div>
                                      
                                      <div *ngIf="vuln.parameters">
                                        <p>Parameters:</p>
                                        <div class="code-block mb-2">{{vuln.parameters}}</div>
                                      </div>
                                    </div>
                                  </div>            
                                  <div class="mb-2" *ngIf="vuln.attack">
                                    <h6 class="vuln-title">Attack Evidence</h6>
                                    <div class="card">
                                      <div class="card-header">
                                        <small class="text-muted">Raw Attack Data</small>
                                      </div>
                                      <div class="card-body">
                                        <div class="code-block" style="max-height: 200px; overflow-y: auto;">
                                          <pre>{{formatAttackData(vuln.attack)}}</pre>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div *ngIf="getFilteredVulnerabilitiesForCategory(category).length === 0" 
                              class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No vulnerabilities in this category match your current filters.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div *ngIf="getFilteredCategories().length === 0" class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No vulnerability categories found matching your current filters.
                  </div>
                </div>                                
                <div *ngIf="selectedTab === 'details'" class="tab-pane fade show active">
                  <div class="accordion" id="scanDetailsAccordion">
                    <div class="accordion-item" *ngFor="let tool of toolResults; let i = index">
                      <h2 class="accordion-header" [id]="'heading' + i">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                [attr.data-bs-target]="'#collapse' + i" 
                                [attr.aria-expanded]="i === 0" 
                                [attr.aria-controls]="'collapse' + i">
                          <i class="fas fa-tools me-2"></i> {{tool.name}}
                          <span class="badge rounded-pill bg-primary ms-2">{{tool.findings.length}} findings</span>
                        </button>
                      </h2>
                      <div [id]="'collapse' + i" class="accordion-collapse collapse" 
                          [ngClass]="{'show': i === 0}"
                          [attr.aria-labelledby]="'heading' + i" 
                          data-bs-parent="#scanDetailsAccordion">
                        <div class="accordion-body">
                          <div *ngIf="tool.findings.length === 0" class="text-muted">
                            No findings from this tool.
                          </div>
                          <ul class="list-group">
                            <li class="list-group-item" *ngFor="let finding of tool.findings">
                              <div class="d-flex justify-content-between align-items-center">
                                <span [ngClass]="{'text-danger':finding.severity === 'high',
                                                'text-warning': finding.severity === 'medium',
                                                'text-secondary': finding.severity === 'low' || finding.severity === 'informational'}">
                                  {{finding.message}}
                                </span>
                                <span class="badge rounded-pill" 
                                      [ngClass]="'bg-' + finding.severity">
                                  {{finding.severity | titlecase}}
                                </span>
                              </div>
                              <div class="small text-muted" *ngIf="finding.location">
                                Location: {{finding.location}}
                              </div>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div *ngIf="selectedTab === 'logs'" class="tab-pane fade show active">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Scan Logs</h5>
                      <button class="btn btn-sm btn-outline-secondary" (click)="downloadLogs()">
                        <i class="fas fa-download me-2"></i>Download Logs
                      </button>
                    </div>
                    <div class="card-body p-0">
                      <div class="logs-container">
                        <div class="log-entry" *ngFor="let log of scanLogs" [ngClass]="log.level">
                          <div class="log-timestamp">{{log.timestamp | date:'HH:mm:ss'}}</div>
                          <div class="log-level">{{log.level | uppercase}}</div>
                          <div class="log-tool">{{log.tool}}</div>
                          <div class="log-message">{{log.message}}</div>
                        </div>  
                        <div *ngIf="scanLogs.length === 0" class="p-3 text-center text-muted">
                          No logs available.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
